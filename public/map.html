<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>MapPin - By Garvofadge</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—ºï¸</text></svg>">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        /* åœ°å›¾å…¨å± */
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* --- æ‚¬æµ®çª—æ ·å¼ --- */
        #floating-card {
            position: absolute;
            top: 80px;            /* è·ç¦»é¡¶éƒ¨ç•™ç‚¹ç©ºéš™ */
            bottom: 80px;         /* è·ç¦»åº•éƒ¨ç•™ç‚¹ç©ºéš™ */
            width: 400px;         /* å›ºå®šå®½åº¦ */
            background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ç™½åº• */
            backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒæ¨¡ç³Šæ•ˆæœ */
            box-shadow: 0 8px 32px rgba(0,0,0,0.2); /* é˜´å½± */
            border-radius: 12px;
            z-index: 1000;        /* å¿…é¡»æ¯”åœ°å›¾é«˜ */
            padding: 25px;
            box-sizing: border-box;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* ä¸æ»‘åŠ¨ç”» */
            
            /* é»˜è®¤çŠ¶æ€: ç¨å¾®å¾€ä¸‹æ²‰ä¸€ç‚¹ï¼Œé€æ˜åº¦ä¸º0 */
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none; /* éšè—æ—¶ä¸æŒ¡é¼ æ ‡ */
        }

        /* æ¿€æ´»çŠ¶æ€ (æ˜¾ç¤º) */
        #floating-card.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto; /* æ˜¾ç¤ºæ—¶å…è®¸ç‚¹å‡» */
        }

        /* --- å·¦å³ä½ç½®ç±» --- */
        .card-left { left: 50px; }  /* æ˜¾ç¤ºåœ¨å±å¹•å·¦ä¾§ */
        .card-right { right: 50px; } /* æ˜¾ç¤ºåœ¨å±å¹•å³ä¾§ */

        /* å†…å®¹æ ·å¼ */
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 24px; cursor: pointer; color: #666;
        }
        .close-btn:hover { color: #000; }
        .meta-info { color: #888; font-size: 0.9em; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #card-body { line-height: 1.6; color: #333; font-size: 1.1em; }

        /* ä¹‹å‰çš„å¼¹çª—è¾“å…¥æ¡†æ ·å¼ */
        .note-form { width: 220px; }
        .note-form input, .note-form textarea { width: 100%; box-sizing: border-box; margin-bottom: 8px; padding: 5px; }
        .note-form button { width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        /*åˆ é™¤æŒ‰é’®æ ·å¼*/
        .delete-btn {
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            float: right; /* è®©æŒ‰é’®é å³ */
        }
        .delete-btn:hover { background: #d9363e; }

        /*ç¼–è¾‘æŒ‰é’®æ ·å¼*/
        .edit-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            float: right; /* è®©æŒ‰é’®é å³ */
        }
        .edit-btn:hover { background: #0056b3; }

        /* æœç´¢æ¡†æ‚¬æµ®åœ¨åœ°å›¾å·¦ä¸Šè§’ */
        #search-container {
            position: absolute;
            top: 20px;
            left: 60px; /* é¿å¼€ Leaflet çš„ç¼©æ”¾æŒ‰é’® */
            z-index: 1000; /* åœ¨åœ°å›¾ä¸Šé¢ */
            width: 250px;
        }
        
        #user-search {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #search-results {
            background: white;
            border-radius: 4px;
            margin-top: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
        }

        .search-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-item:hover { background: #f0f2f5; }

        #visiting-banner {
            margin-top: 10px;
            background: #007bff;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #visiting-banner button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }

        /* å¥½å‹ç¬”è®°: ç»¿è‰² */
        .friend-marker {
            filter: hue-rotate(260deg) brightness(1.2); /* è°ƒæ•´è‰²ç›¸å˜æˆç»¿è‰²/é’è‰² */
        }
        /* ä¹‹å‰çš„ç§å¯†ç¬”è®°: çº¢è‰²/ç´«è‰² */
        .private-marker {
            filter: hue-rotate(140deg);
        }
    </style>
</head>
<body>
    
    <div id="map"></div>

    <div id="user-profile" style="position:absolute; top:20px; right:20px; z-index:1000; text-align:right;">
        <img id="my-avatar" src="/uploads/avatars/default-avatar.png" 
             style="width:50px; height:50px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3); cursor:pointer;"
             onclick="document.getElementById('avatar-input').click()" 
             title="ç‚¹å‡»æ›´æ¢å¤´åƒ">
        
        <input type="file" id="avatar-input" accept="image/*" style="display:none;" onchange="openCropModal(this)">
        
        <div id="my-username" style="background:rgba(255,255,255,0.8); padding:2px 5px; border-radius:4px; font-weight:bold; display:inline-block; margin-top:5px;">Loading...</div>
    </div>

    <div id="search-container">
        <input type="text" id="user-search" placeholder="ğŸ” æœç´¢ç”¨æˆ·..." oninput="searchUsers()">
        <div id="search-results"></div> <div id="visiting-banner" style="display:none;">
            æ­£åœ¨æµè§ˆ: <b id="visit-name"></b> çš„åœ°å›¾
            <button onclick="exitVisitMode()">é€€å‡º</button>
        </div>

        <div style="margin-top: 10px;">
            <button id="inbox-btn" onclick="toggleInbox()" style="width:100%; padding:8px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">
                ğŸ“© å¥½å‹è¯·æ±‚ <span id="request-count">(0)</span>
            </button>
            
            <div id="inbox-list" style="display:none; background:white; margin-top:5px; border-radius:4px; box-shadow:0 4px 10px rgba(0,0,0,0.1); max-height:200px; overflow-y:auto;">
                </div>
        </div>

        <div id="visiting-banner" style="display:none;">...</div>
    </div>


    <div id="floating-card" class="hidden">
        <button class="close-btn" onclick="closeCard()">Ã—</button>
        <div id="card-content">
            <h2 id="card-title">æ ‡é¢˜</h2>
            <div class="meta-info">
                <span id="card-author">ä½œè€…</span> | 
                <span id="card-time">æ—¶é—´</span>
            </div>
            <div id="card-body">å†…å®¹...</div>

            <div id="card-footer" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;"></div>
        </div>
    </div>

    <div id="crop-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; flex-direction:column; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:80vh; display:flex; flex-direction:column;">
            <h3 style="margin:0 0 10px 0;">è£å‰ªå¤´åƒ</h3>
            
            <div style="height:300px; width:100%; background:#f0f0f0; overflow:hidden;">
                <img id="crop-image" style="max-width:100%;">
            </div>
            
            <div style="margin-top:15px; text-align:right;">
                <button onclick="closeCropModal()" style="padding:8px 15px; margin-right:10px;">å–æ¶ˆ</button>
                <button onclick="confirmCrop()" style="padding:8px 15px; background:#28a745; color:white; border:none; border-radius:4px;">âœ… ç¡®è®¤ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ä»æµè§ˆå™¨ç¼“å­˜é‡Œè¯»å–ç™»é™†å­˜å…¥çš„ç”¨æˆ·å
        const CURRENT_USER = localStorage.getItem('currentUser'); 

        //å¦‚æœè¿˜æ²¡æœ‰ç™»é™†,å›æ»šç™»å½•é¡µ
        if(!CURRENT_USER) {
            alert("è¯·å…ˆç™»å½•ï¼");
            window.location.href = 'login.html';
        }

        // A. åˆå§‹åŒ–åœ°å›¾ (è®¾ç½®ä¸­å¿ƒç‚¹ä¸ºSEUï¼Œç¼©æ”¾çº§åˆ« 10)
        const map = L.map('map',{ doubleClickZoom: false }).setView([31.8889, 118.8142], 10);

        // B. åŠ è½½ OpenStreetMap ç“¦ç‰‡
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // æˆ‘ä»¬æŠŠä¹‹å‰çš„ marker å­˜èµ·æ¥ï¼Œæ–¹ä¾¿æ¸…é™¤
        let currentMarkers = [];

        // --- C. åŠ è½½å·²æœ‰çš„ç¬”è®° ---
        async function loadNotes(targetUser = null) {
            //æ‹¿è¯
            const token = localStorage.getItem('userToken');
            if (!token) {
                // å¦‚æœæ²¡ç™»å½•ï¼Œç›´æ¥è¸¢å›ç™»å½•é¡µ
                window.location.href = 'login.html';
                return;
            }

            // æ¸…é™¤æ—§æ ‡è®°
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = []; // æ¸…ç©ºæ•°ç»„

            let url = `http://localhost:3000/notes`;
            if (targetUser) {
                url += `&targetUser=${targetUser}`;
            }

            // å‘é€è¯·æ±‚ (å¸¦ Token)
            const res = await fetch(url, {
                headers: { 
                    'Authorization': 'Bearer ' + token 
                }
            });

            // å¤„ç†ç»“æœ (å¦‚æœ Token è¿‡æœŸï¼Œåç«¯ä¼šè¿”å› 403)
            if (res.status === 403 || res.status === 401) {
                alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                window.location.href = 'login.html';
                return;
            }

            const notes = await res.json();

            notes.forEach(note => {

                // å†³å®šæ˜¯å¦åŠ æ»¤é•œç±»å
                let customClassName = '';
            
                if (note.visibility === 'private') {
                    customClassName = 'private-marker'; // çº¢è‰²
                } else if (note.visibility === 'friends') {
                    customClassName = 'friend-marker';  // ç»¿è‰²
                }

                // åˆ›å»ºè‡ªå®šä¹‰ Icon (Leaflet æœºåˆ¶)
                const myIcon = L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    tooltipAnchor: [16, -28],
                    className: customClassName // âš¡ï¸ å…³é”®ç‚¹ï¼šåŠ ä¸Šæˆ‘ä»¬çš„ CSS ç±»
                });

                // åœ¨åœ°å›¾ä¸Šæ·»åŠ æ ‡è®°
                // L.marker([note.lat, note.lng])
                //  .addTo(map)
                //  .bindPopup(`<b>${note.title}</b><br>${note.content}<br><small>by ${note.username}</small>`);
                // 1.åˆ›å»ºæ ‡è®°
                const marker = L.marker([note.lat, note.lng], { icon: myIcon }).addTo(map);

                // 2.ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºæ‚¬æµ®çª—
                marker.on('click', function(e){
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡(é˜²æ­¢è§¦å‘åœ°å›¾çš„ click äº‹ä»¶)
                    L.DomEvent.stopPropagation(e);
                    showFloatingCard(note);
                });

                //é¼ æ ‡æ‚¬åœæ˜¾ç¤ºç¬”è®°ä¿¡æ¯
                const dateStr = new Date(note.created_at).toLocaleDateString();

                //ä½¿ç”¨ HTML å†…å®¹
                const tooltipContent = `
                <div style="text-align:center;line-height: 1.4;">
                    <b style="font-size: 14px;">${note.title}</b><br>
                    <span style="color: #666; font-size: 12px;">${note.username} Â· ${dateStr}</span>
                </div>
                `;
                //ç»‘å®š Tooltip
                marker.bindTooltip(tooltipContent, {
                    direction: 'top', 
                    offset: [0, -30],
                    className: 'custom-tooltip'
                });

                // âš¡ï¸ å…³é”®: å­˜å…¥æ•°ç»„
                currentMarkers.push(marker);
            });

            // å¦‚æœæ˜¯è®¿é—®åˆ«äººï¼Œè‡ªåŠ¨è°ƒæ•´åœ°å›¾è§†é‡ï¼ŒåŒ…å«æ‰€æœ‰ç¬”è®°
            if (targetUser && notes.length > 0) {
                const group = new L.featureGroup(currentMarkers);
                map.fitBounds(group.getBounds());
            }
        }

        // --- æ˜¾ç¤ºæ‚¬æµ®çª— ---
        function showFloatingCard(note) {
            const card = document.getElementById('floating-card');

            // è®¡ç®—æ ‡è®°åœ¨å±å¹•ä¸Šçš„åƒç´ ä½ç½®
            const screenPoint = map.latLngToContainerPoint([note.lat, note.lng]);
            const screenWidth = window.innerWidth;

            //æ¸…æ¥šæ—§ä½ç½®ç±»,é˜²æ­¢å†²çª
            card.classList.remove('card-left', 'card-right');

            // åˆ¤æ–­å·¦å³ä½ç½®
            // å¦‚æœ x > å±å¹•ä¸€åŠ,è¯´æ˜æ ‡è®°åœ¨å³è¾¹,æ‚¬æµ®çª—åº”è¯¥åœ¨å·¦è¾¹
            if (screenPoint.x > screenWidth / 2){
                card.classList.add('card-left');
            } else {
                //å¦åˆ™åœ¨å³è¾¹
                card.classList.add('card-right');
            }


            // ç¼–è¾‘(ç»™æ ‡é¢˜å’Œå†…å®¹åŠ ç‰¹å®šçš„ IDï¼Œæ–¹ä¾¿åé¢ JS æ‰¾å®ƒä»¬)
            card.setAttribute('data-current-note-id', note.id); // å­˜å‚¨å½“å‰ç¬”è®° IDï¼Œåˆ é™¤æ—¶ä¼šç”¨åˆ°
            
            //æ¸²æŸ“åªè¯»æ¨¡å¼çš„HTML
            renderReadMode(note);


            //æ·»åŠ æ¿€æ´»ç±»,è§¦å‘ css æ˜¾ç¤ºåŠ¨ç”»
            card.classList.add('active');

            //ç§»é™¤hiddenç±»,é˜²æ­¢æ ·å¼å†²çª
            card.classList.remove('hidden');
        }

        // --- è¾…åŠ©å‡½æ•° :æ¸²æŸ“åªè¯»æ¨¡å¼---
        function renderReadMode(note) {
            // è·å– Token
            const token = localStorage.getItem('userToken');
            
            // âš¡ï¸ æ ¸å¿ƒé»‘ç§‘æŠ€: ç»™å›¾ç‰‡/è§†é¢‘ URL åŠ ä¸Š Token åç¼€
            // æˆ‘ä»¬ç”¨æ­£åˆ™æ›¿æ¢: æŠŠ /uploads/resources/xxx å˜æˆ /uploads/resources/xxx?token=...
            let processedContent = note.content;
            
            if (token) {
                // æ­£åˆ™è§£é‡Š: åŒ¹é… /uploads/resources/ åé¢è·Ÿç€ä»»æ„éç©ºå­—ç¬¦
                // æ’é™¤æ‰å·²ç»å¸¦äº† ?token çš„ (é˜²æ­¢é‡å¤æ·»åŠ )
                const regex = /(\/uploads\/resources\/[^\s\)\"\']+)/g;
                
                processedContent = processedContent.replace(regex, (match) => {
                    // å¦‚æœå·²ç»æœ‰ ? äº† (æ¯”å¦‚æ–‡ä»¶åé‡Œå¸¦?)ï¼Œç”¨ & è¿æ¥ï¼Œå¦åˆ™ç”¨ ?
                    const separator = match.includes('?') ? '&' : '?';
                    return `${match}${separator}token=${token}`;
                });
            }

            // 1. æŠŠ Markdown è½¬æ¢æˆ HTML
            // æ¯”å¦‚: "# æ ‡é¢˜" å˜æˆ "<h1>æ ‡é¢˜</h1>"
            const rawHtml = marked.parse(processedContent);

            // âš¡ï¸ å…è®¸ video å’Œ audio æ ‡ç­¾ï¼Œä»¥åŠå®ƒä»¬çš„ src, controls ç­‰å±æ€§
            const cleanHtml = DOMPurify.sanitize(rawHtml, {
                ADD_TAGS: ['video', 'audio', 'source'],
                ADD_ATTR: ['src', 'controls', 'width', 'height', 'preload', 'type']
            });

            document.getElementById('card-content').innerHTML = `
               <h2 id="card-title">${note.title}</h2>
               <div class="meta-info">
                    <span>${note.username}</span> | 
                    <span>${new Date(note.created_at).toLocaleDateString()}</span>
                </div>
                <div id="card-body" class="markdown-body" style="margin-top:15px; line-height:1.6;">
                    ${cleanHtml}
                </div>

                <div id="card-footer" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                    ${getFooterButtons(note)}
                </div>
            `;
        }

        // --- è¾…åŠ©å‡½æ•° :æ ¹æ®ç”¨æˆ·æƒé™è¿”å›åº•éƒ¨æŒ‰é’® ---
        function getFooterButtons(note) {
            //åªæœ‰ä½œè€…è‡ªå·±èƒ½çœ‹åˆ°åˆ é™¤æŒ‰é’®
            if(CURRENT_USER === note.username) {
                return `
                    <button onclick="deleteNote(${note.id})" class="delete-btn">ğŸ—‘ï¸ åˆ é™¤ç¬”è®°</button>
                    <button onclick='enableEditMode(${JSON.stringify(note)})' class="edit-btn">âœï¸ ç¼–è¾‘</button>
                `;
            }
            return  ''; //å…¶ä»–äººæ²¡æœ‰æŒ‰é’®
        }

        // --- å…³é—­æ‚¬æµ®çª— ---
        function closeCard() {
            const card = document.getElementById('floating-card');

            // å…³é”®ç‚¹ï¼šåªç§»é™¤ active ç±»ï¼
            // è¿™æ · card-left æˆ– card-right ä¾ç„¶ä¿ç•™ç€ï¼Œ
            // å¡ç‰‡ä¼šåœ¨åŸåœ°æ·¡å‡ºï¼Œä¸ä¼šè·³åˆ°å·¦è¾¹ã€‚
            card.classList.remove('active');
            
            // å¯é€‰ï¼šä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼Œå¯ä»¥åŠ ä¸€ä¸ª hidden ç±»ï¼Œä½†åœ¨ CSS ä¸­ä¸»è¦é  .active æ§åˆ¶
            card.classList.add('hidden');
        }

        loadNotes(); // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ

        // --- åœ°å›¾ç‚¹å‡»äº‹ä»¶ ---
        let tempMarker = null; // ä¸´æ—¶æ ‡è®°

        //å•æœºæ¸…ç©ºæ‚¬æµ®çª—
        map.on('click', function() {
            const card = document.getElementById('floating-card');

            //åªæœ‰å¡ç‰‡æ˜¯activeçŠ¶æ€æ—¶,æ‰æœ‰å…³é—­æ•ˆæœ
            if(card.classList.contains('active')){
                closeCard();
            }

            //è‹¥æ— å¡ç‰‡æ‰“å¼€,åˆ™ä»€ä¹ˆä¹Ÿä¸åš,é˜²æ­¢è¯¯è§¦
        });

        //åŒå‡»æ·»åŠ ç¬”è®°
        map.on('dblclick', function(e) {
            // å¦‚æœç‚¹å‡»åœ°å›¾ç©ºç™½å¤„,å…ˆå…³é—­æ‚¬æµ®çª—
            closeCard(); 

            //è·å–åŒå‡»ä½ç½®
            const { lat, lng } = e.latlng;

            // 1. å¦‚æœä¹‹å‰æœ‰æ²¡ä¿å­˜çš„æ¡†ï¼Œå…ˆåˆ æ‰
            //if (tempMarker) map.removeLayer(tempMarker);

            // 2. ç”Ÿæˆå¼¹çª— HTML è¡¨å•
            const popupContent = `
                <div class="note-form">
                    <h3>å†™ç¬”è®°</h3>
                    <input id="note-title" placeholder="æ ‡é¢˜" style="margin-bottom:5px; width:100%;">
                    
                    <select id="note-visibility" style="width:100%; margin-bottom:5px; padding:5px;">
                        <option value="public">ğŸŒ å…¬å¼€ (æ‰€æœ‰äººå¯è§)</option>
                        <option value="friends">ğŸ¤ å¥½å‹ (ä»…äº’å…³å¥½å‹)</option>
                        <option value="private">ğŸ”’ ç§å¯† (ä»…è‡ªå·±å¯è§)</option>
                    </select>

                    <div style="margin-bottom: 5px; background: #f8f9fa; padding: 5px; border-radius: 4px;">
                        <button onclick="document.getElementById('create-file-input').click()" style="cursor:pointer; border:1px solid #ddd; background:white; padding:2px 8px; border-radius:4px;">
                            ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡/è§†é¢‘
                        </button>
                        <input type="file" id="create-file-input" hidden onchange="handleFileUpload(this, 'note-content')">
                    </div>
                    
                    <textarea id="note-content" placeholder="æ”¯æŒ Markdown..." rows="5" style="width:100%;"></textarea>
                    <button onclick="saveNote(${lat}, ${lng})">å‘å¸ƒ</button>
                </div>
            `;

            // 3. åœ¨ç‚¹å‡»å¤„æ˜¾ç¤ºå¼¹çª—
            //tempMarker = L.popup()
            L.popup()
                .setLatLng([lat, lng])
                .setContent(popupContent)
                .openOn(map);
        });

        // --- E. ä¿å­˜ç¬”è®°åŠŸèƒ½ ---
        async function saveNote(lat, lng) {
            const rawTitle = document.getElementById('note-title').value;
            const rawContent = document.getElementById('note-content').value;
            const visibility = document.getElementById('note-visibility').value;

            // ä»æµè§ˆå™¨ç¼“å­˜æ‹¿ Token
            const token = localStorage.getItem('userToken');

            // å¦‚æœæ²¡ Tokenï¼Œè¯´æ˜æ²¡ç™»å½•ï¼Œç›´æ¥è¸¢å‡ºå»
            if (!token) {
                alert("è¯·å…ˆç™»å½•ï¼");
                window.location.href = 'login.html';
                return;
            }

            if (!rawTitle) return alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©º");

            // å‘é€ç»™åç«¯
            const res = await fetch('http://localhost:3000/notes', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify({ title: rawTitle, content: rawContent, lat, lng, visibility })
            });

            const data = await res.json();

            if (data.success) {
                // å…³é—­å¼¹çª—
                map.closePopup();
                loadNotes(); 
                alert("å‘å¸ƒæˆåŠŸï¼");
            } else {
                alert("å‘å¸ƒå¤±è´¥");
            }
        }

        // --- åˆ é™¤ç¬”è®° ---
        async function deleteNote(noteId) {
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™è¿™æ¡ç¬”è®°å—?æ­¤æ“ä½œä¸å¯æ¢å¤.")) {
                return;
            }

            const token = localStorage.getItem('userToken'); // æ‹¿è¯
            if (!token) return alert("è¯·å…ˆç™»å½•");

            try {
                const res = await fetch(`http://localhost:3000/notes/${noteId}`, {
                    method: 'DELETE',
                    headers: {
                         'Content-Type': 'application/json',
                         'Authorization': 'Bearer ' + token // âš¡ï¸ äº®è¯
                    }
                });

                const data = await res.json();

                if(data.success) {
                    closeCard(); //å…³é—­å¡ç‰‡
                    loadNotes();
                    alert("åˆ é™¤æˆåŠŸ");
                } else {
                    alert("åˆ é™¤å¤±è´¥:" + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("è¯·æ±‚å‡ºé”™");
            }
        }


        // --- å¯ç”¨ç¼–è¾‘æ¨¡å¼ ---
        function enableEditMode(note) {
            const contentDiv = document.getElementById('card-content');

            // åˆ¤æ–­å½“å‰æ˜¯ public è¿˜æ˜¯ privateï¼Œå†³å®šå“ªä¸ª option è¢« selected
            const isPublic = (note.visibility === 'public') ? 'selected' : '';
            const isFriends = (note.visibility === 'friends') ? 'selected' : '';
            const isPrivate = (note.visibility === 'private') ? 'selected' : '';

            // æ„é€  HTML
            contentDiv.innerHTML = `
                <input type="text" id="edit-title" value="${note.title}" style="width:100%; font-size:1.5em; font-weight:bold; margin-bottom:5px;">
                
                <select id="edit-visibility" style="width:100%; margin-bottom:10px; padding:5px; border:1px solid #ddd; border-radius:4px;">
                    <option value="public" ${isPublic}>ğŸŒ å…¬å¼€ (æ‰€æœ‰äººå¯è§)</option>
                    <option value="friends" ${isFriends}>ğŸ¤ å¥½å‹</option>
                    <option value="private" ${isPrivate}>ğŸ”’ ç§å¯† (ä»…è‡ªå·±å¯è§)</option>
                </select>

                <div style="margin-bottom: 5px; background: #f8f9fa; padding: 5px; border-radius: 4px;">
                    <button onclick="document.getElementById('edit-file-input').click()" style="cursor:pointer; border:1px solid #ddd; background:white; padding:2px 8px; border-radius:4px;">
                        ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡/è§†é¢‘
                    </button>
                    <input type="file" id="edit-file-input" hidden onchange="handleFileUpload(this, 'edit-content')">
                </div>

                <div class="meta-info">æ­£åœ¨ç¼–è¾‘...</div>
                <textarea id="edit-content" rows="6" style="width:100%; padding:5px;">${note.content}</textarea>
                
                <div style="margin-top: 10px; text-align: right;">
                    <button onclick='cancelEdit(${JSON.stringify(note)})' style="margin-right:10px;">å–æ¶ˆ</button>
                    <button onclick="saveEdit(${note.id})" style="background:#28a745; color:white; padding:5px 15px; border:none; cursor:pointer;">ğŸ’¾ ä¿å­˜</button>
                </div>
            `;
        }


        // --- å–æ¶ˆç¼–è¾‘ ---
        function cancelEdit(note) {
            // ç›´æ¥é‡æ–°æ¸²æŸ“å›åªè¯»æ¨¡å¼çš„ HTML å°±è¡Œäº†
            renderReadMode(note);
        }

        // --- ä¿å­˜ç¼–è¾‘ ---
        async function saveEdit(noteId) {
            const newTitle = document.getElementById('edit-title').value;
            const newContent = document.getElementById('edit-content').value;
            const newVisibility = document.getElementById('edit-visibility').value;

            const token = localStorage.getItem('userToken'); // æ‹¿è¯
            if (!token) return alert("è¯·å…ˆç™»å½•");

            try {
                const res = await fetch(`http://localhost:3000/notes/${noteId}`, {
                    method: 'PUT', // ä½¿ç”¨ PUT æ–¹æ³•æ›´æ–°
                    headers: {
                        'Content-Type': 'application/json' ,
                        'Authorization': 'Bearer ' + token // âš¡ï¸ äº®è¯
                    },
                    body: JSON.stringify({ 
                        title: newTitle, 
                        content: newContent,
                        visibility: newVisibility
                    })
                });

                const data = await res.json();
                if (data.success) {
                    loadNotes();
                    closeCard();
                    alert("ä¿®æ”¹æˆåŠŸ!");

                } else {
                    alert("ä¿å­˜å¤±è´¥: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("è¯·æ±‚å‡ºé”™");
            }
        }

        // --- æœç´¢ç”¨æˆ· ---
        let searchTimeout;
        function searchUsers() {
            //æ‹¿è¯
            const token = localStorage.getItem('userToken');
            if (!token) {
                // å¦‚æœæ²¡ç™»å½•ï¼Œç›´æ¥è¸¢å›ç™»å½•é¡µ
                window.location.href = 'login.html';
                return;
            }

            const query = document.getElementById('user-search').value;
            const resultsDiv = document.getElementById('search-results');
            
            // é˜²æŠ–: åœæ­¢è¾“å…¥ 300ms åæ‰å‘é€è¯·æ±‚
            clearTimeout(searchTimeout);
            if (!query) { resultsDiv.innerHTML = ''; return; }

            searchTimeout = setTimeout(async () => {
                const res = await fetch(`http://localhost:3000/users/search?q=${query}`,{
                    headers: {
                        'Authorization': 'Bearer ' + token // âš¡ï¸ äº®è¯
                    }
                });
                const users = await res.json();

                resultsDiv.innerHTML = users.map(user => {
                    // ä¸èƒ½åŠ è‡ªå·±
                    if (user.username === CURRENT_USER) return '';
                    
                    return `
                    <div class="search-item" style="display:flex; justify-content:space-between; align-items:center;">
                        <span onclick="visitUser('${user.username}')" style="cursor:pointer; flex-grow:1;">
                            ğŸ‘¤ ${user.username}
                        </span>
                        
                        <button onclick="event.stopPropagation(); sendFriendRequest('${user.username}')" 
                                style="background:#28a745; color:white; border:none; border-radius:3px; padding:2px 8px; cursor:pointer; font-size:12px;">
                            â• åŠ å¥½å‹
                        </button>
                    </div>
                    `;
                }).join('');
            }, 300);
        }

        // --- è®¿é—®ç”¨æˆ· (è¿›å…¥ä¸»é¡µæ¨¡å¼) ---
        function visitUser(targetName) {
            // 1. éšè—æœç´¢ç»“æœ
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('user-search').value = '';

            // 2. æ˜¾ç¤ºâ€œæ­£åœ¨è®¿é—®â€æ¨ªå¹…
            document.getElementById('visiting-banner').style.display = 'flex';
            document.getElementById('visit-name').innerText = targetName;

            // 3. é‡æ–°åŠ è½½åœ°å›¾ï¼Œåªçœ‹è¿™ä¸ªäººçš„ç¬”è®°
            loadNotes(targetName);
            
            // 4. å…³é—­å¯èƒ½æ‰“å¼€çš„æ‚¬æµ®çª—
            closeCard();
        }

        // --- é€€å‡ºè®¿é—®æ¨¡å¼ ---
        function exitVisitMode() {
            document.getElementById('visiting-banner').style.display = 'none';
            // é‡æ–°åŠ è½½å…¨å›¾ (ä¸ä¼ å‚)
            loadNotes();
        }


        // --- A. å‘é€å¥½å‹è¯·æ±‚ ---
        async function sendFriendRequest(targetName) {
            if (!confirm(`ç¡®å®šè¦å‘ ${targetName} å‘é€å¥½å‹ç”³è¯·å—?`)) return;

            try {
                const res = await fetch('http://localhost:3000/friends/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('userToken')
                    },
                    body: JSON.stringify({ requester: CURRENT_USER, receiver: targetName })
                });
                const data = await res.json();
                alert(data.message); // æ˜¾ç¤º "ç”³è¯·å·²å‘é€" æˆ– "å·²ç»æ˜¯å¥½å‹äº†"
            } catch (err) {
                console.error(err);
                alert("è¯·æ±‚å‘é€å¤±è´¥");
            }
        }

        // --- B. åˆ·æ–°/æ˜¾ç¤ºå¥½å‹è¯·æ±‚ä¿¡ç®± ---
        async function toggleInbox() {
            const listDiv = document.getElementById('inbox-list');
            
            // å¦‚æœå½“å‰æ˜¯å…³ç€çš„ï¼Œå°±æ‰“å¼€å¹¶åŠ è½½æ•°æ®
            if (listDiv.style.display === 'none') {
                listDiv.style.display = 'block';
                await loadInbox();
            } else {
                listDiv.style.display = 'none';
            }
        }

        async function loadInbox() {
            const res = await fetch(`http://localhost:3000/friends/pending`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('userToken')
                }
            });
            const requests = await res.json();

            // æ›´æ–°æŒ‰é’®ä¸Šçš„æ•°å­—
            document.getElementById('request-count').innerText = `(${requests.length})`;

            const listDiv = document.getElementById('inbox-list');
            if (requests.length === 0) {
                listDiv.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">æš‚æ— æ–°è¯·æ±‚</div>';
                return;
            }

            // æ¸²æŸ“åˆ—è¡¨
            listDiv.innerHTML = requests.map(req => `
                <div style="padding:10px; border-bottom:1px solid #eee;">
                    <div><b>${req.requester}</b> æƒ³åŠ ä½ ä¸ºå¥½å‹</div>
                    <div style="margin-top:5px; text-align:right;">
                        <button onclick="respondToRequest(${req.id}, 'accepted')" style="background:#28a745; color:white; border:none; padding:4px 8px; cursor:pointer; margin-right:5px;">åŒæ„</button>
                        <button onclick="respondToRequest(${req.id}, 'rejected')" style="background:#dc3545; color:white; border:none; padding:4px 8px; cursor:pointer;">æ‹’ç»</button>
                    </div>
                </div>
            `).join('');
        }

        // --- C. åŒæ„/æ‹’ç»è¯·æ±‚ ---
        async function respondToRequest(id, action) {
            try {
                const res = await fetch('http://localhost:3000/friends/response', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('userToken')
                    },
                    body: JSON.stringify({ id, action })
                });
                const data = await res.json();
                if (data.success) {
                    // æˆåŠŸåé‡æ–°åŠ è½½ä¿¡ç®±ï¼Œåˆ—è¡¨é¡¹ä¼šè‡ªåŠ¨æ¶ˆå¤±
                    loadInbox(); 
                    alert(action === 'accepted' ? "å·²æ·»åŠ å¥½å‹!" : "å·²æ‹’ç»è¯·æ±‚");
                }
            } catch (err) {
                alert("æ“ä½œå¤±è´¥");
            }
        }

        // âš¡ï¸ é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰æ–°æ¶ˆæ¯
        loadInbox();

        // --- A. åŠ è½½ç”¨æˆ·ä¿¡æ¯ (å¤´åƒ) ---
        async function loadUserProfile() {
            const token = localStorage.getItem('userToken');
            if (!token) return; // æ²¡ç™»å½•å°±ä¸ç®¡äº†

            try {
                const res = await fetch('http://localhost:3000/users/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const user = await res.json();
                
                // æ›´æ–°åå­—
                document.getElementById('my-username').innerText = user.username;
                
                // æ›´æ–°å¤´åƒ (å¦‚æœæœ‰çš„è¯)
                if (user.avatar) {
                    // æ³¨æ„: user.avatar å­˜çš„æ˜¯ "/uploads/xxx.jpg"
                    // æµè§ˆå™¨ä¼šè‡ªåŠ¨æŠŠå®ƒæ‹¼æ¥åˆ° http://localhost:3000 åé¢
                    document.getElementById('my-avatar').src = 'http://localhost:3000' + user.avatar;
                }
                else {
                    // å¦‚æœæ²¡æœ‰ä¸Šä¼ è¿‡ï¼Œå°±ç”¨é»˜è®¤å›¾
                    document.getElementById('my-avatar').src = 'http://localhost:3000/uploads/avatars/default-avatar.png';
                }
            } catch (err) {
                console.error("åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥", err);
            }
        }

        // --- B. ä¸Šä¼ å¤´åƒ ---


        // async function uploadAvatar() {
        //     const fileInput = document.getElementById('avatar-input');
        //     const file = fileInput.files[0];
        //     if (!file) return;

        //     // âš ï¸ å…³é”®ç‚¹: å‘é€æ–‡ä»¶å¿…é¡»ç”¨ FormData
        //     const formData = new FormData();
        //     formData.append('avatar', file); // è¿™é‡Œçš„ 'avatar' å¿…é¡»å’Œåç«¯ upload.single('avatar') å¯¹åº”

        //     const token = localStorage.getItem('userToken');

        //     try {
        //         const res = await fetch('http://localhost:3000/users/avatar', {
        //             method: 'POST',
        //             headers: {
        //                 'Authorization': 'Bearer ' + token
        //                 // âŒ åƒä¸‡ä¸è¦è‡ªå·±è®¾ç½® 'Content-Type': 'multipart/form-data' !!!
        //                 // æµè§ˆå™¨ä¼šè‡ªåŠ¨è®¾ç½®ï¼Œå¹¶åŠ ä¸Š boundaryï¼Œå¦‚æœä½ è‡ªå·±è®¾äº†åè€Œä¼šæŠ¥é”™ã€‚
        //             },
        //             body: formData
        //         });

        //         const data = await res.json();
        //         if (data.success) {
        //             // ç«‹å³æ›´æ–°é¡µé¢ä¸Šçš„å¤´åƒ
        //             document.getElementById('my-avatar').src = 'http://localhost:3000' + data.avatarUrl;
        //             alert("å¤´åƒæ›´æ¢æˆåŠŸï¼");
        //         } else {
        //             alert("ä¸Šä¼ å¤±è´¥: " + data.message);
        //         }
        //     } catch (err) {
        //         console.error(err);
        //         alert("ä¸Šä¼ å‡ºé”™");
        //     }
        // }


        let cropper; // å…¨å±€å˜é‡ï¼Œå­˜æ”¾è£å‰ªå™¨å®ä¾‹
        const cropImage = document.getElementById('crop-image');
        const cropModal = document.getElementById('crop-modal');

        // --- æ‰“å¼€è£å‰ªçª—å£ ---
        function openCropModal(input) {
            const file = input.files[0];
            if (!file) return;

            // æ£€æŸ¥å¤§å° (å‰ç«¯å…ˆæ‹¦ä¸€æ¬¡ï¼Œåç«¯å†æ‹¦ä¸€æ¬¡åŒé‡ä¿é™©)
            if (file.size > 5 * 1024 * 1024) {
                alert("å›¾ç‰‡å¤ªå¤§äº†ï¼è¯·ä¸Šä¼  5MB ä»¥å†…çš„å›¾ç‰‡");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // 1. æŠŠè¯»å–åˆ°çš„å›¾ç‰‡æ”¾è¿› img æ ‡ç­¾
                cropImage.src = e.target.result;
                
                // 2. æ˜¾ç¤ºæ¨¡æ€æ¡†
                cropModal.style.display = 'flex';

                // 3. é”€æ¯æ—§çš„è£å‰ªå™¨ (å¦‚æœå­˜åœ¨)ï¼Œé˜²æ­¢é‡å¤
                if (cropper) { cropper.destroy(); }

                // 4. åˆå§‹åŒ– Cropper
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1 / 1, // é”å®š 1:1 æ¯”ä¾‹
                    viewMode: 1,        // é™åˆ¶è£å‰ªæ¡†ä¸èƒ½ç§»å‡ºå›¾ç‰‡èŒƒå›´
                    dragMode: 'move',   // å…è®¸æ‹–æ‹½å›¾ç‰‡
                    autoCropArea: 0.8,  // é»˜è®¤è£å‰ªåŒºåŸŸå¤§å°
                });
            };
            reader.readAsDataURL(file);
            
            // æ¸…ç©º inputï¼Œå¦åˆ™é€‰åŒä¸€å¼ å›¾ä¸ä¼šè§¦å‘ onchange
            input.value = ''; 
        }

        // --- 2. å…³é—­è£å‰ªçª—å£ ---
        function closeCropModal() {
            cropModal.style.display = 'none';
            if (cropper) cropper.destroy();
        }

        // --- 3. ç¡®è®¤è£å‰ªå¹¶ä¸Šä¼  ---
        function confirmCrop() {
            if (!cropper) return;

            // è·å–è£å‰ªåçš„ Canvas
            // width: 300 é™åˆ¶æœ€ç»ˆå›¾ç‰‡å¤§å°ä¸º 300x300ï¼Œæ—¢èŠ‚çœæµé‡åˆä¿è¯æ¸…æ™°åº¦
            const canvas = cropper.getCroppedCanvas({
                width: 1000, 
                height: 1000
            });

            // æŠŠ Canvas è½¬æˆ Blob (äºŒè¿›åˆ¶æ–‡ä»¶å¯¹è±¡)
            canvas.toBlob(async (blob) => {
                // æ¥ä¸‹æ¥å°±å’Œä¹‹å‰çš„ä¸Šä¼ é€»è¾‘ä¸€æ ·äº†ï¼
                const formData = new FormData();
                // ç»™ Blob èµ·ä¸ªåå­—ï¼Œæ¯”å¦‚ avatar.jpg
                formData.append('avatar', blob, 'avatar.jpg');

                const token = localStorage.getItem('userToken');

                try {
                    const res = await fetch('http://localhost:3000/users/avatar', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token },
                        body: formData
                    });

                    const data = await res.json();
                    if (data.success) {
                        // æ›´æ–°é¡µé¢æ˜¾ç¤º
                        // åŠ ä¸ªæ—¶é—´æˆ³é˜²æ­¢æµè§ˆå™¨ç¼“å­˜æ—§å¤´åƒ
                        document.getElementById('my-avatar').src = 'http://localhost:3000' + data.avatarUrl + '?t=' + new Date().getTime();
                        alert("å¤´åƒæ›´æ¢æˆåŠŸï¼");
                        closeCropModal();
                    } else {
                        alert("ä¸Šä¼ å¤±è´¥: " + data.message);
                    }
                } catch (err) {
                    console.error(err);
                    alert("ä¸Šä¼ å‡ºé”™");
                }
            });
        }
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–å¤´åƒ
        loadUserProfile();

        // --- å¤„ç†æ–‡ä»¶é€‰æ‹©ä¸ä¸Šä¼  ---
        // inputElement: è§¦å‘äº‹ä»¶çš„ input æ ‡ç­¾
        // textAreaId: è¦æ’å…¥å†…å®¹çš„æ–‡æœ¬æ¡† ID (å› ä¸ºåˆ›å»ºå’Œç¼–è¾‘æ˜¯ä¸¤ä¸ªä¸åŒçš„æ–‡æœ¬æ¡†)
        async function handleFileUpload(inputElement, textAreaId) {
            const file = inputElement.files[0];
            if (!file) return;

            // ç®€å•çš„ loading æç¤º
            const textArea = document.getElementById(textAreaId);
            const originalPlaceholder = textArea.placeholder;
            textArea.placeholder = "æ­£åœ¨ä¸Šä¼ ä¸­...";

            const formData = new FormData();
            formData.append('file', file);

            const token = localStorage.getItem('userToken');

            try {
                const res = await fetch('http://localhost:3000/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    let insertText = '';
                    
                    // æ ¹æ®ç±»å‹ç”Ÿæˆä¸åŒçš„ Markdown/HTML ä»£ç 
                    if (data.type === 'image') {
                        // å›¾ç‰‡: Markdown æ ¼å¼
                        insertText = `\n![${data.originalName}](${data.url})\n`;
                    } else if (data.type === 'video') {
                        // è§†é¢‘: HTML æ ¼å¼ (è®¾ç½®å®½åº¦ 100% é€‚åº”å¡ç‰‡)
                        insertText = `\n<video src="${data.url}" controls width="100%"></video>\n`;
                    } else if (data.type === 'audio') {
                        // éŸ³é¢‘: HTML æ ¼å¼
                        insertText = `\n<audio src="${data.url}" controls></audio>\n`;
                    } else {
                        // å…¶ä»–æ–‡ä»¶: é“¾æ¥æ ¼å¼
                        insertText = `\n[ğŸ“ ä¸‹è½½: ${data.originalName}](${data.url})\n`;
                    }

                    // åœ¨å…‰æ ‡ä½ç½®æ’å…¥
                    insertAtCursor(textArea, insertText);
                    
                } else {
                    alert("ä¸Šä¼ å¤±è´¥: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("ä¸Šä¼ å‡ºé”™");
            } finally {
                inputElement.value = ''; // æ¸…ç©ºï¼Œå…è®¸é‡å¤ä¼ åŒä¸€å¼ 
                textArea.placeholder = originalPlaceholder;
            }
        }

        // --- 2. åœ¨å…‰æ ‡å¤„æ’å…¥æ–‡æœ¬ (é€šç”¨å·¥å…·å‡½æ•°) ---
        function insertAtCursor(myField, myValue) {
            // IE/Edge/Chrome/Firefox æ”¯æŒ selectionStart
            if (myField.selectionStart || myField.selectionStart == '0') {
                var startPos = myField.selectionStart;
                var endPos = myField.selectionEnd;
                // æ’å…¥æ–‡æœ¬
                myField.value = myField.value.substring(0, startPos)
                    + myValue
                    + myField.value.substring(endPos, myField.value.length);
                // æ¢å¤å…‰æ ‡ä½ç½®
                myField.selectionStart = startPos + myValue.length;
                myField.selectionEnd = startPos + myValue.length;
            } else {
                myField.value += myValue;
            }
            // è§¦å‘ä¸€ä¸‹ input äº‹ä»¶ï¼Œé˜²æ­¢æŸäº›æ¡†æ¶æ²¡æ£€æµ‹åˆ°å˜åŒ– (è™½ç„¶è¿™é‡Œç”¨ä¸ä¸Š)
            myField.dispatchEvent(new Event('input')); 
        }


    </script>
</body>
</html>